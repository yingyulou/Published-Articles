# 一个操作系统的设计与实现

# 第9章 硬盘驱动

操作系统应当具备读写硬盘的能力，所以本章将要实现的是硬盘驱动。硬盘驱动涉及大量的端口读写指令，所以，本章代码使用汇编语言实现。

## 9.1 读硬盘

想要读硬盘，就需要提供以下三个信息：

1. 起始扇区号
2. 读取的扇区数，只能是一个8位整数
3. 数据存储的地址

请看本章代码`9/HD.s`。

第13\~15行，将读取的扇区数写入`0x1f2`端口。

第17\~32行，将起始扇区号写入`0x1f3~0x1f6`端口。

第34\~36行，将读硬盘命令`0x20`写入`0x1f7`端口。

第38\~43行，等待硬盘准备就绪。

第45\~47行，计算循环的总次数。一个扇区是512字节，`insw`指令一次处理2字节，所以，每读一个扇区，就需要256次循环，循环的总次数等于读取的扇区数左移8位。

第48\~49行，将硬盘中的数据读出。

## 9.2 写硬盘

请看本章代码`9/HD.s`。

第58\~82行，与`hdRead`函数一致。

第84\~86行，将写硬盘命令`0x30`写入`0x1f7`端口。

第88\~97行，与`hdRead`函数一致。

第98\~99行，将数据写入硬盘。

## 9.3 编译与测试

本章代码`9/Makefile`新增了`HD.s`的编译与链接命令。

本章代码`9/Kernel.c`测试了硬盘驱动。

