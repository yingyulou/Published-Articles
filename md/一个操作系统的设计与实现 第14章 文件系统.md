# 一个操作系统的设计与实现

# 第14章 文件系统

文件系统是操作系统的一个重要组成部分。本章将要实现文件系统。

## 14.1 文件系统的实现原理

文件系统是操作系统用于管理硬盘，并使硬盘更易于使用的模块。

想要管理硬盘，就需要记录硬盘扇区的使用情况，可以使用位图实现这个需求。想要让硬盘更易于使用，就需要一个关键概念：文件。文件可以将底层的起始扇区号、扇区数等信息用一个文件名代替，存储这些信息的数据结构被称为文件控制块（File Control Block，FCB）。使用文件系统时，可以从文件名出发，找到其对应的FCB，并从中取出起始扇区号、扇区数等信息，提供给更底层的函数使用。此外，上述操作不能仅仅停留在内存中，而是要将其及时写入硬盘。

文件系统并不是一个很复杂的概念，但由于硬盘与CPU之间的效率相差甚远（约5个数量级），所以，工业级的操作系统使用了大量非常复杂的技术以提高文件系统的效率；很多书籍也使用了非常大的篇幅论述文件系统的实现细节。在我们的操作系统中，不考虑文件系统的效率问题。

## 14.2 实现文件系统

请看本章代码`14/Util.hpp`。

`strcmp`是本章新增的函数，其用于判断两个字符串是否相等。

`strcpy`是本章新增的函数，其用于复制字符串。

接下来，请看本章代码`14/FS.h`。

第5\~10行，定义了FCB结构体。FCB中需要存放一个文件的起始扇区号和扇区数，一共8字节；然后，需要决定文件名的最大长度，我们的操作系统将FCB的大小凑整到16字节，所以，文件名的最大长度为7。

接下来，请看本章代码`14/FS.hpp`。

第10\~14行，定义了若干常量：

* `__FS_SUPER_BLOCK`：超级块扇区号
* `__FS_BITMAP_BLOCK`：硬盘位图扇区号
* `__FS_START_BLOCK`：文件起始扇区号
* `__FS_MAGIC`：文件系统魔数
* `__FS_FCB_COUNT`：最大支持的FCB数量

这些常量的含义见下文。

第16行，定义了FCB列表。我们的操作系统使用一个扇区存放FCB，且FCB列表中的最后一项被用于魔数（见下文）。

第17行，定义了硬盘位图的缓冲区，大小为一个扇区。硬盘位图用于管理扇区的使用情况，其存放在硬盘中，这里定义的是其在内存中的读写缓冲区。一个扇区的位图能够管理4096个扇区，共2M。

第18行，定义了硬盘位图。

`fsInit`函数用于初始化文件系统。文件系统是一个持久化的系统，仅需要在硬盘上还不存在文件系统时初始化一次，所以，需要使用一个魔数来标识硬盘上是否存在文件系统。在工业级的操作系统中，魔数一般定义在超级块（Super Block）中，超级块存放的是一些文件系统的核心信息。我们的操作系统的超级块中只需要存放一个魔数，所以，实现上没有单独构造超级块，而是将FCB列表中的最后一个FCB作废，并在此位置存储魔数。

我们的操作系统内核使用了硬盘的前98个扇区，所以，文件系统的FCB列表可以存放在第98扇区；硬盘位图可以存放在第99扇区；从第100扇区开始可用于存放文件。

第22行，从硬盘中读取FCB列表。

第24行，验证魔数。

第26\~28行，如果魔数验证通过，就说明文件系统已存在，且位于第99扇区的硬盘位图是有效的，可将其读出，然后初始化`hdBitmap`。

第30行，如果魔数验证不通过，则初始化文件系统。这个分支只会运行一次，如果读者想要调试这个分支，可以不断修改魔数的取值，或删除虚拟硬盘并重新创建。

第32\~33行，清零FCB列表，然后填入魔数。

第34行，初始化硬盘位图。

第36\~37行，将新的FCB列表和硬盘位图写入硬盘。

`fsList`函数相当于Linux的`ls`命令。

第44行，遍历每个FCB。

第46行，判断FCB的起始扇区号是否为0。FCB会被初始化为0，而一个文件的起始扇区号不可能为0（至少为100），所以，如果一个FCB的起始扇区号为0，就说明这个FCB为空。

第48行，如果FCB不为空，则打印这个FCB的文件名，起始扇区号和扇区数。

`__allocateFCB`函数用于在FCB列表中找到一个空的FCB，并返回其索引值。如果找不到，则返回-1。

`fsCreate`函数用于创建文件。在我们的操作系统中，创建文件的过程如下：

1. 在一个很大的起始扇区号（如1000）处写入一个文件
2. 调用`fsCreate`函数，将这个文件安装到文件系统中

第70\~75行，尝试分配一个FCB索引值。如果分配失败，则退出此函数。

第77\~79行，填写FCB的3个数据成员。

第81\~87行，将文件复制到文件系统中。

第89\~90行，将新的FCB列表和硬盘位图写入硬盘。

`__findFCB`函数用于在FCB列表中查找指定的文件名，并返回FCB的索引值。如果找不到，则返回-1。

`fsDelete`函数用于删除文件。

第110\~115行，尝试查找被删除文件的FCB索引值，如果找不到，则退出此函数。

第117行，将此文件从硬盘位图中删除。

第118行，将此文件从FCB列表中删除。

第120\~121行，将新的FCB列表和硬盘位图写入硬盘。

`fsLoad`函数用于从文件名加载3特权级任务。

第127行，尝试查找文件的FCB索引值。

第129\~132行，如果找到了文件的FCB，则从中取出该文件的起始扇区号和扇区数，然后调用`loadTaskPL3`函数。

接下来，请看本章代码`14/Kernel.c`。

第16行，初始化文件系统。

## 14.3 编译与测试

本章代码`14/Kernel.c`测试了文件系统。

