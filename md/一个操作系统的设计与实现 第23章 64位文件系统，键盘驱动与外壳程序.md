# 一个操作系统的设计与实现

# 第23章 64位文件系统，键盘驱动与外壳程序

## 23.1 64位文件系统

本章代码`23/FS.h`和`23/FS.hpp`实现了文件系统，其实现思路与32位操作系统一致，这里不再赘述。

## 23.2 64位键盘驱动

想要实现键盘驱动，就需要先实现一个具有阻塞功能的IO缓冲区。IO缓冲区的实现位于本章代码`23/Buffer.h`和`23/Buffer.hpp`中，其实现思路与32位操作系统一致，这里不再赘述。

键盘驱动的实现位于本章代码`23/Keyboard.h`和`23/Keyboard.hpp`中，其实现思路与32位操作系统一致，这里不再赘述。

键盘接在IO APIC上，IO APIC使用索引寄存器和数据寄存器进行访问，其中，索引寄存器的地址是`0xfec00000`，数据寄存器的地址是`0xfec00010`。键盘在IO APIC中的索引是`0x12`和`0x13`，其中，`0x12`号寄存器用于设定中断向量号等信息，`0x13`号寄存器用于设定中断需要发送给哪个CPU。在我们的操作系统中，`0x12`号寄存器固定设为`0x21`，表示键盘中断的中断向量号是`0x21`；`0x13`号寄存器固定设为`0x0`，表示键盘中断发送给第一个CPU。

接下来，请看本章代码`23/Int.hpp`。

第22\~25行，在IO APIC中安装键盘中断。

接下来，请看本章代码`23/Int.s`。

`intKeyboard`函数是键盘中断处理函数。

第90\~91行，发送中断响应信号。

第93\~95行，从`0x60`端口读取键盘扫描码，然后调用键盘驱动函数。

第168行，在中断处理函数表中安装键盘中断处理函数。

接下来，请看本章代码`23/Syscall.s`。

第55行，在系统调用表中安装`inputStr`函数，其系统调用号是1。

## 23.3 64位外壳程序

本章代码`23/Shell.h`和`23/Shell.hpp`实现了外壳程序，其实现思路与32位操作系统一致，这里不再赘述。

## 23.4 编译与测试

本章代码`23/Test.c`继续测试0号和2号系统调用。新增的循环用于使任务的运行时间变长，以观察3特权级任务与外壳程序共存时的状态。

本章代码`23/Kernel.c`测试了外壳程序。

