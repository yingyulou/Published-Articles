# 一个操作系统的设计与实现

# 第1章 什么是操作系统

## 1.1 引言

什么是操作系统呢？

有些读者可能会像曾经的笔者一样，认为操作系统是"一种图形界面"；在学习了Linux操作系统后，认为操作系统也可以是"一种命令行"。而不同种类，不同版本的操作系统，则是"不同的图形界面"，或是"不同的命令行语法"。

那么，以Linux操作系统为例，读者是否想过这些问题呢？

* 为什么输入`ls`命令，屏幕上就显示了文件列表？
* 什么是"文件"？
* 为什么在键盘上按一下`l`键，屏幕上就会显示一个字母`l`，而不是别的字母，或者没反应？`s`键也是一样
* 计算机怎么知道键盘被按下了？又怎么知道按的是什么键？
* 怎么在屏幕上显示一个字符？

这一系列越来越底层的问题乍一看都问的莫名其妙，尤其是最后一个：学过C语言的读者都知道，用C语言的`printf`函数，不就行了吗？

那么，`printf`函数又是怎么实现的呢？

看来，事情并没有这么简单。这些看似莫名其妙的问题，都指向了一个词：操作系统。

上述所有问题的答案，都可以用一句比较笼统的话来回答：由操作系统对这些功能提供支持。而其中原理，正是本系列要向读者讲述的。

欢迎来到操作系统的实现之旅！

## 1.2 准备工作

想要实现一个操作系统，需要进行一些准备工作。

首先是一台安装有Linux操作系统的物理机或虚拟机，且带有GCC编译器。

然后，需要安装汇编编译器nasm，其官网为`https://nasm.us/`，笔者使用的版本为：`2.16.01`。编译命令为：

```bash
./configure --prefix=... && make -jN && make install
```

然后，需要安装bochs虚拟机，其官网为`https://bochs.sourceforge.io/`，笔者使用的版本为：`2.7`。bochs拥有强大的硬件模拟及调试功能，其用于运行我们的操作系统。bochs需要以不同的命令安装两次，如下所示：

* 运行版本：

  ```bash
  ./configure --prefix=... --enable-x86-64 --enable-smp --with-x --with-x11 && make -jN && make install
  ```

* 调试器版本：

  ```bash
  ./configure --prefix=... --enable-x86-64 --enable-smp --enable-debugger --with-x --with-x11 && make -jN && make install
  ```

注意两次编译的`--prefix`应不同，否则就覆盖了。由于这两个版本的bochs名字一样，所以，读者应将第二个bochs更名，笔者使用的名称是`bochsdbg`。第一次编译得到的bochs程序用于运行操作系统；第二次编译得到的bochsdbg程序用于调试操作系统，当操作系统出现问题时，就依靠它了。

然后，需要为两个版本的bochs分别构造一个配置文件。第一个配置文件需要放在`~/.bochsrc`处，其内容为：

```
cpu: count=4
romimage: file=$BXSHARE/BIOS-bochs-latest
vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest
boot: disk
ata0-master: type=disk, path="Arena.img", mode=flat
megs: 32
clock: sync=realtime, rtc_sync=1, time0=local
```

此配置文件中，第5行设定的是虚拟硬盘信息，`Arena.img`文件将在下文中创建；第6行设定的是内存容量，单位是M；其他配置无需关注。

第二个配置文件需要放在`~/.bochsdbgrc`处，其内容为：

```
cpu: count=4
romimage: file=$BXSHARE/BIOS-bochs-latest
vgaromimage: file=$BXSHARE/VGABIOS-lgpl-latest
boot: disk
ata0-master: type=disk, path="Arena.img", mode=flat
megs: 32
display_library: x, options="gui_debug"
magic_break: enabled=1
```

此配置文件中，第7行用于启用bochsdbg的GUI，第8行用于启用"魔法断点"功能，此功能将在后续章节中介绍。

然后，需要创建`~/.bochscmd`文件，其内容为：

```
b 0x7c00
c
d 1
```

此文件用于使bochsdbg在启动时跳过BIOS。

然后，需要在`~/.bashrc`中将两个版本的bochs与其配置文件分别对应起来：

```bash
export PATH=.../bochs/bin:$PATH
export PATH=.../bochsdbg/bin:$PATH
alias bochs="bochs -q -f ~/.bochsrc -unlock"
alias bochsdbg="bochsdbg -q -f ~/.bochsdbgrc -unlock -rc ~/.bochscmd"
```

然后，需要创建虚拟硬盘。虚拟硬盘实际上就是一个普通的文件，创建命令如下：

```bash
dd if=/dev/zero of=Arena.img count=20480
```

上述命令将创建一个10M容量的虚拟硬盘。

至此，所有的准备工作就都完成了。

如果现在运行`bochs`命令，bochs会显示："No bootable device"（没有可引导的设备），这是正常的，因为现在什么都还没有实现。在下一章中，我们将正式开始实现操作系统。

本系列源码可从[https://github.com/yingyulou/Published-Articles/tree/master/code/os](https://github.com/yingyulou/Published-Articles/tree/master/code/os)获得。

